<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My GitHub Repos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .custom-alert {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background-color: #111827; color: white; padding: 10px 20px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10000; opacity: 0;
      transition: opacity .25s ease-in-out; pointer-events: none;
    }
    .custom-alert.show { opacity: 1; }
    .folder-icon {
      display:inline-block; margin-right:8px; width:16px; height:16px;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z'%3E%3C/path%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:center;
    }
    .rot { transform: rotate(90deg); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-7xl mx-auto p-4 space-y-4">
    <h1 class="text-3xl font-bold text-center">My GitHub Repositories</h1>

    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
      <div class="md:col-span-3 flex gap-2">
        <input id="usernameInput" type="text" value="boobalootoo"
          class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="GitHub username">
      </div>

      <div class="md:col-span-3 flex gap-2">
        <button id="updateBtn"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Update</button>
        <button id="clearCacheBtn"
          class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700">Clear Cache</button>
      </div>

      <div class="md:col-span-3 flex gap-2">
        <input id="searchRepos" type="text" placeholder="Search repos"
          class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input id="searchFiles" type="text" placeholder="Search files/folders"
          class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <div class="md:col-span-3 flex flex-col md:flex-row gap-2 items-stretch md:items-center">
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="px-2 py-2 border rounded-lg">
            <option value="category">By Category</option>
            <option value="recent">Most Recent</option>
          </select>
        </div>
        <div id="recentControls" class="hidden items-center gap-2">
          <label class="text-sm">Scope</label>
          <select id="recentScope" class="px-2 py-2 border rounded-lg">
            <option value="repos">Repos</option>
            <option value="files">Files</option>
          </select>
          <label class="text-sm">Show</label>
          <input id="recentCount" type="range" min="1" max="100" step="1" value="20">
          <span id="recentCountLabel" class="text-sm w-10 text-right">20</span>
        </div>
      </div>
    </div>

    <p class="text-sm text-gray-600">
      Tip: Nothing loads until you interact. Click a category header to fetch repo names. Click “Load files” on a repo to fetch its files.
      File “last edited” times are fetched lazily and cached to reduce API calls.
    </p>

    <!-- Category list -->
    <div id="repoList" class="space-y-4">
      <p class="text-center text-gray-500">Ready. No API calls have been made yet.</p>
    </div>
  </div>

  <!-- Popups omitted for brevity (same as your version) -->

  <div id="customAlert" class="custom-alert"></div>

  <script>
    // ... (all your helpers, state management, API wrappers, etc. unchanged) ...

    // ---------- Recent mode ----------
    viewModeSel.addEventListener('change', ()=>{
      const mode = viewModeSel.value;
      if (mode === 'recent'){ 
        recentControls.classList.remove('hidden'); 
        renderRecent(); 
      } else { 
        recentControls.classList.add('hidden'); 
        renderScaffold(usernameInput.value.trim()); 
      }
    });

    recentScopeSel.addEventListener('change', renderRecent);

    // only updates label while dragging
    recentCountRange.addEventListener('input', ()=>{
      recentCountLabel.textContent = recentCountRange.value;
    });

    // only re-renders on release
    recentCountRange.addEventListener('change', renderRecent);

    async function renderRecent(){
      const username = usernameInput.value.trim();
      if (!username){ showAlert("Enter a username first."); return; }
      const count = parseInt(recentCountRange.value,10);
      const scope = recentScopeSel.value;
      const state = loadState(username);

      repoList.innerHTML = '';

      if (scope === 'repos'){
        const repos = await ensureRepos(username);
        repos.sort((a,b)=> new Date(b.pushed_at) - new Date(a.pushed_at));
        recentCountRange.max = repos.length;  // ✅ slider max = number of repos
        repos.slice(0,count).forEach(repo=>{
          const { category, cleanDesc } = getRepoCategory(repo.description);
          const temp = document.createElement('div');
          temp.innerHTML = repoCardHTML(repo, cleanDesc, username);
          repoList.appendChild(temp.firstElementChild);
        });
        attachRepoCardEvents(repoList, username);
      } else {
        // files
        let files = [];
        for (const [repo, cache] of Object.entries(state.fileMeta||{})){
          const [r,path] = repo.split('|');
          const meta = state.fileMeta[repo];
          if (meta?.lastEditedISO){
            files.push({ repo:r, path, ...meta });
          }
        }
        files.sort((a,b)=> new Date(b.lastEditedISO) - new Date(a.lastEditedISO));
        recentCountRange.max = files.length || 1; // ✅ slider max = number of files
        files.slice(0,count).forEach(f=>{
          const li = document.createElement('div');
          li.className = "text-sm bg-white rounded p-2 border";
          li.textContent = `${f.repo}/${f.path} — ${new Date(f.lastEditedISO).toLocaleString()}`;
          repoList.appendChild(li);
        });
      }
    }
  </script>
</body>
</html>
